theory AEAD_mac_then_enc_enc_then_mac begin

// Function signature and definition of the equational theory E

functions: enc/3, fst/1, left/1, mac/2, pair/2, right/1, snd/1
equations: fst(<x.1, x.2>) = x.1, snd(<x.1, x.2>) = x.2







rule (modulo E) Setup:
   [ Fr( ~k1 ), Fr( ~k2 ) ]
  --[ OnlyOnce( ), Setup( ~k1, ~k2 ) ]->
   [ !Key( ~k1 ), !Key( ~k2 ) ]

rule (modulo E) Alice_makemac_then_enc:
   [ Fr( ~m ), !Key( ~k1 ), !Key( ~k2 ), Fr( ~nonce ), Fr( ~data ) ]
  -->
   [
   Out( <enc(<~m, mac(<~m, ~nonce, ~data>, ~k1)>, ~k2, ~nonce), ~nonce, 
         ~data, mac(<~m, ~nonce, ~data>, ~k1)>
   )
   ]

rule (modulo E) Alice_enc_then_mac:
   [ Fr( ~m ), !Key( ~k1 ), !Key( ~k2 ), Fr( ~nonce ), Fr( ~data ) ]
  -->
   [
   Out( <enc(~m, ~k2, ~nonce), ~nonce, ~data, 
         mac(<enc(~m, ~k2, ~nonce), ~nonce, ~data>, ~k1)>
   )
   ]

rule (modulo E) diff_check:
   [
   In( <c1, ~nonce, ~data, alicetag> ), In( <c2, ~nonce, ~data, alicetag> )
   ]
  -->
   [ Out( diff(c1, c2) ) ]

restriction unique [right]:
  "∀ #i #j. ((OnlyOnce( ) @ #i) ∧ (OnlyOnce( ) @ #j)) ⇒ (#i = #j)"
  // safety formula

restriction unique [left]:
  "∀ #i #j. ((OnlyOnce( ) @ #i) ∧ (OnlyOnce( ) @ #j)) ⇒ (#i = #j)"
  // safety formula

diffLemma Observational_equivalence:
rule-equivalence
  case Rule_Equality
  backward-search
    case LHS
    step( simplify )
    step( solve( !KD( x ) ▶₁ #i ) )
      case diff_check
      step( solve( (#vl, 0) ~~> (#i, 1) ) )
        case Var_msg_t
        step( solve( !KU( ~nonce ) @ #vk.5 ) )
          case Alice_enc_then_mac_case_1
          step( solve( !KU( ~data ) @ #vk.6 ) )
            case Alice_enc_then_mac_case_1
            by ATTACK // trace found
          qed
        qed
      qed
    qed
  qed
qed

/* All wellformedness checks were successful. */

/*
Generated from:
Tamarin version 1.10.0
Maude version 2.7.1
Git revision: UNKNOWN, branch: UNKNOWN
Compiled at: 2024-10-30 14:56:23.355649243 UTC
*/

end

==============================================================================
summary of summaries:

analyzed: code5-D.spthy
  
  DiffLemma:  Observational_equivalence : falsified - found trace (8 steps)

==============================================================================
